// Agentic CRM - Database Schema
generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [pgvector(map: "vector")]
}

// ============================================================================
// USER MANAGEMENT & AUTHENTICATION
// ============================================================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String
  image         String?
  title         String? // Job title
  department    String?
  phone         String?
  isActive      Boolean   @default(true)
  externalId    String?   @unique // External ID from Azure AD or Frappe
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?

  // Relations
  role          Role      @relation(fields: [roleId], references: [id])
  roleId        String
  team          Team?     @relation(fields: [teamId], references: [id])
  teamId        String?

  // Ownership relations
  opportunities           Opportunity[]        @relation("OpportunityOwner")
  activities              Activity[]
  tasks                   Task[]               @relation("TaskAssignee")
  createdTasks            Task[]               @relation("TaskCreator")
  notes                   Note[]
  approvalRequests        ApprovalRequest[]    @relation("ApprovalRequester")
  approvalReviews         ApprovalRequest[]    @relation("ApprovalReviewer")
  auditLogs               AuditLog[]
  aiInteractions          AIInteraction[]
  savedViews              SavedView[]
  notifications           Notification[]
  notificationPreferences NotificationPreference[]

  @@index([email])
  @@index([roleId])
  @@index([teamId])
  @@map("users")
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique // "Sales User", "Sales Manager", "Admin", "Executive"
  description String?
  permissions Json // Array of permission strings
  isSystem    Boolean  @default(false) // Cannot be deleted
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users User[]

  @@map("roles")
}

model Team {
  id          String   @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users         User[]
  opportunities Opportunity[]

  @@map("teams")
}

// ============================================================================
// CLIENTS & CONTACTS
// ============================================================================

model Client {
  id            String   @id @default(cuid())
  name          String
  domain        String? // Company website domain
  industry      String?
  size          String? // "1-10", "11-50", "51-200", etc.
  revenue       Decimal? @db.Decimal(15, 2)
  location      String?
  country       String?
  description   String?  @db.Text
  logoUrl       String?
  isActive      Boolean  @default(true)
  externalId    String?  @unique // From external CRM/ERP
  enrichedAt    DateTime? // Last enrichment timestamp
  enrichmentData Json? // Firmographics from enrichment API
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  contacts      Contact[]
  opportunities Opportunity[]

  @@index([name])
  @@index([domain])
  @@map("clients")
}

model Contact {
  id          String   @id @default(cuid())
  firstName   String
  lastName    String
  email       String?
  phone       String?
  title       String? // Job title
  department  String?
  isPrimary   Boolean  @default(false)
  linkedInUrl String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId    String

  activities  Activity[]

  @@index([clientId])
  @@index([email])
  @@map("contacts")
}

// ============================================================================
// OPPORTUNITIES & LIFECYCLE
// ============================================================================

model Opportunity {
  id                String   @id @default(cuid())
  title             String
  description       String?  @db.Text
  value             Decimal  @db.Decimal(15, 2)
  currency          String   @default("USD")
  probability       Int      @default(0) // 0-100%
  expectedCloseDate DateTime?
  actualCloseDate   DateTime?
  source            String? // "Inbound", "Outbound", "Referral", "Partner"
  priority          String   @default("Medium") // "Low", "Medium", "High", "Critical"
  tags              String[] // Array of tags
  metadata          Json? // Flexible JSON for custom fields
  duplicateOf       String? // Reference to merged opportunity
  isArchived        Boolean  @default(false)
  archivedAt        DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  client            Client          @relation(fields: [clientId], references: [id])
  clientId          String
  owner             User            @relation("OpportunityOwner", fields: [ownerId], references: [id])
  ownerId           String
  team              Team?           @relation(fields: [teamId], references: [id])
  teamId            String?
  stage             Stage           @relation(fields: [stageId], references: [id])
  stageId           String
  type              OpportunityType @relation(fields: [typeId], references: [id])
  typeId            String

  // Child relations
  activities        Activity[]
  tasks             Task[]
  notes             Note[]
  attachments       Attachment[]
  stageHistory      StageHistory[]
  approvalRequests  ApprovalRequest[]
  aiInteractions    AIInteraction[]
  leadScore         LeadScore?
  vectorEmbedding   VectorEmbedding?

  @@index([clientId])
  @@index([ownerId])
  @@index([stageId])
  @@index([typeId])
  @@index([teamId])
  @@index([createdAt])
  @@index([expectedCloseDate])
  @@map("opportunities")
}

model Stage {
  id               String   @id @default(cuid())
  name             String   @unique
  order            Int // Display order
  probability      Int      @default(0) // Default probability %
  color            String   @default("#6B7280") // Hex color for UI
  isClosed         Boolean  @default(false) // Is this a terminal stage?
  isWon            Boolean  @default(false) // Is this a won stage?
  requiredFields   String[] // Array of required field names
  requiredDocs     String[] // Array of required document types
  allowedNextStages String[] // Array of stage IDs that can be transitioned to
  slaHours         Int? // SLA in hours for this stage
  isSystem         Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  opportunities Opportunity[]
  stageHistory  StageHistory[]

  @@index([order])
  @@map("stages")
}

model OpportunityType {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  opportunities Opportunity[]

  @@map("opportunity_types")
}

model StageHistory {
  id            String   @id @default(cuid())
  enteredAt     DateTime @default(now())
  exitedAt      DateTime?
  durationHours Int? // Auto-calculated
  notes         String?  @db.Text

  opportunity   Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  opportunityId String
  stage         Stage       @relation(fields: [stageId], references: [id])
  stageId       String

  @@index([opportunityId])
  @@index([stageId])
  @@index([enteredAt])
  @@map("stage_history")
}

// ============================================================================
// ACTIVITIES & COLLABORATION
// ============================================================================

model Activity {
  id          String   @id @default(cuid())
  type        String // "Call", "Email", "Meeting", "Note", "Stage Change", "Assignment"
  subject     String?
  description String?  @db.Text
  duration    Int? // In minutes
  scheduledAt DateTime?
  completedAt DateTime?
  outcome     String? // "Scheduled", "Completed", "No Answer", "Left Voicemail", etc.
  isSystem    Boolean  @default(false) // Auto-generated vs manual
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  opportunity Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  opportunityId String
  user        User        @relation(fields: [userId], references: [id])
  userId      String
  contact     Contact?    @relation(fields: [contactId], references: [id])
  contactId   String?

  @@index([opportunityId])
  @@index([userId])
  @@index([type])
  @@index([scheduledAt])
  @@map("activities")
}

model Task {
  id          String    @id @default(cuid())
  title       String
  description String?   @db.Text
  dueDate     DateTime?
  completedAt DateTime?
  priority    String    @default("Medium") // "Low", "Medium", "High", "Urgent"
  status      String    @default("Open") // "Open", "In Progress", "Completed", "Cancelled"
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  opportunity   Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  opportunityId String
  assignee      User        @relation("TaskAssignee", fields: [assigneeId], references: [id])
  assigneeId    String
  createdBy     User        @relation("TaskCreator", fields: [createdById], references: [id])
  createdById   String

  @@index([opportunityId])
  @@index([assigneeId])
  @@index([dueDate])
  @@index([status])
  @@map("tasks")
}

model Note {
  id          String   @id @default(cuid())
  content     String   @db.Text
  mentions    String[] // Array of user IDs mentioned
  isPinned    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  opportunity   Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  opportunityId String
  author        User        @relation(fields: [authorId], references: [id])
  authorId      String

  @@index([opportunityId])
  @@index([authorId])
  @@map("notes")
}

model Attachment {
  id          String   @id @default(cuid())
  fileName    String
  fileType    String // MIME type
  fileSize    Int // In bytes
  filePath    String // Storage path/URL
  category    String? // "Proposal", "Contract", "Presentation", etc.
  uploadedAt  DateTime @default(now())

  opportunity   Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  opportunityId String

  @@index([opportunityId])
  @@map("attachments")
}

// ============================================================================
// WORKFLOW & APPROVALS
// ============================================================================

model ApprovalRequest {
  id          String   @id @default(cuid())
  type        String // "Stage Transition", "Value Change", "Close Deal"
  reason      String?  @db.Text
  status      String   @default("Pending") // "Pending", "Approved", "Rejected", "Cancelled"
  comments    String?  @db.Text
  requestedAt DateTime @default(now())
  reviewedAt  DateTime?

  opportunity   Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  opportunityId String
  requester     User        @relation("ApprovalRequester", fields: [requesterId], references: [id])
  requesterId   String
  reviewer      User?       @relation("ApprovalReviewer", fields: [reviewerId], references: [id])
  reviewerId    String?

  @@index([opportunityId])
  @@index([status])
  @@map("approval_requests")
}

// ============================================================================
// NOTIFICATIONS
// ============================================================================

model Notification {
  id        String   @id @default(cuid())
  type      String // "Task Due", "Mention", "Approval", "SLA Breach", "AI Suggestion"
  title     String
  message   String   @db.Text
  link      String? // Deep link to relevant page
  isRead    Boolean  @default(false)
  readAt    DateTime?
  createdAt DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

model NotificationPreference {
  id      String  @id @default(cuid())
  channel String // "Email", "In-App", "Teams", "Slack"
  type    String // Notification type
  enabled Boolean @default(true)

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  @@unique([userId, channel, type])
  @@map("notification_preferences")
}

// ============================================================================
// AI & AGENTIC FEATURES
// ============================================================================

model AIInteraction {
  id           String   @id @default(cuid())
  type         String // "Query", "Draft", "Suggestion", "Analysis", "Automation"
  prompt       String   @db.Text
  response     String   @db.Text
  status       String   @default("Pending") // "Pending", "Approved", "Rejected", "Applied"
  confidence   Float? // 0.0 to 1.0
  toolsCalled  Json? // Array of tools/functions called
  cost         Decimal? @db.Decimal(10, 6) // USD cost
  latencyMs    Int? // Response time in milliseconds
  feedback     String? // "Useful", "Not Useful", "Harmful"
  feedbackText String?  @db.Text
  createdAt    DateTime @default(now())
  reviewedAt   DateTime?

  user          User         @relation(fields: [userId], references: [id])
  userId        String
  opportunity   Opportunity? @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  opportunityId String?

  @@index([userId])
  @@index([opportunityId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@map("ai_interactions")
}

model LeadScore {
  id              String   @id @default(cuid())
  score           Int // 0-100
  scoreVersion    String // Model version
  factors         Json // Breakdown of scoring factors
  confidence      Float // 0.0 to 1.0
  recommendedAction String? // "Contact immediately", "Nurture", "Disqualify"
  calculatedAt    DateTime @default(now())
  
  opportunity   Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  opportunityId String      @unique

  @@index([score])
  @@map("lead_scores")
}

model VectorEmbedding {
  id        String                     @id @default(cuid())
  embedding Unsupported("vector(1536)") // OpenAI embedding dimension
  content   String                     @db.Text // The text that was embedded
  metadata  Json? // Additional context
  createdAt DateTime                   @default(now())

  opportunity   Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  opportunityId String      @unique

  @@map("vector_embeddings")
}

// ============================================================================
// SAVED VIEWS & PREFERENCES
// ============================================================================

model SavedView {
  id          String   @id @default(cuid())
  name        String
  filters     Json // Filter configuration
  sortBy      Json? // Sort configuration
  isDefault   Boolean  @default(false)
  isPublic    Boolean  @default(false) // Shared with team
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  @@index([userId])
  @@map("saved_views")
}

// ============================================================================
// AUDIT & COMPLIANCE
// ============================================================================

model AuditLog {
  id          String   @id @default(cuid())
  entity      String // "Opportunity", "Stage", "User", etc.
  entityId    String
  action      String // "Create", "Update", "Delete", "Stage Change", "Export"
  changes     Json? // Before/after values
  ipAddress   String?
  userAgent   String?
  timestamp   DateTime @default(now())

  user   User?   @relation(fields: [userId], references: [id])
  userId String?

  @@index([entity, entityId])
  @@index([userId])
  @@index([timestamp])
  @@map("audit_logs")
}

// ============================================================================
// CONFIGURATION & MASTER DATA
// ============================================================================

model SystemConfig {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  category  String // "General", "AI", "Integrations", "Security"
  description String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@map("system_config")
}
