// Agentic CRM - Database Schema
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// ============================================================================
// USER MANAGEMENT & AUTHENTICATION
// ============================================================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String
  image         String?
  title         String?
  department    String?
  phone         String?
  isActive      Boolean   @default(true)
  externalId    String?   @unique
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?

  // Relations
  role          Role      @relation(fields: [roleId], references: [id])
  roleId        String
  team          Team?     @relation(fields: [teamId], references: [id])
  teamId        String?

  // Ownership relations
  opportunities           Opportunity[]        @relation("OpportunityOwner")
  activities              Activity[]
  tasks                   Task[]               @relation("TaskAssignee")
  createdTasks            Task[]               @relation("TaskCreator")
  notes                   Note[]
  approvalRequests        ApprovalRequest[]    @relation("ApprovalRequester")
  approvalReviews         ApprovalRequest[]    @relation("ApprovalReviewer")
  auditLogs               AuditLog[]
  aiInteractions          AIInteraction[]
  savedViews              SavedView[]
  notifications           Notification[]
  notificationPreferences NotificationPreference[]

  @@index([email])
  @@index([roleId])
  @@index([teamId])
  @@map("users")
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  permissions Json
  isSystem    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users User[]

  @@map("roles")
}

model Team {
  id          String   @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users         User[]
  opportunities Opportunity[]

  @@map("teams")
}

// ============================================================================
// CLIENTS & CONTACTS
// ============================================================================

model Client {
  id            String   @id @default(cuid())
  name          String
  domain        String?
  industry      String?
  size          String?
  revenue       Decimal?
  location      String?
  country       String?
  description   String?
  logoUrl       String?
  isActive      Boolean  @default(true)
  externalId    String?  @unique
  enrichedAt    DateTime?
  enrichmentData Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  contacts      Contact[]
  opportunities Opportunity[]

  @@index([name])
  @@index([domain])
  @@map("clients")
}

model Contact {
  id          String   @id @default(cuid())
  firstName   String
  lastName    String
  email       String?
  phone       String?
  title       String?
  department  String?
  isPrimary   Boolean  @default(false)
  linkedInUrl String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId    String

  activities  Activity[]

  @@index([clientId])
  @@index([email])
  @@map("contacts")
}

// ============================================================================
// RESOURCES (HRMS MOCK)
// ============================================================================

model Resource {
  id              String @id @default(cuid())
  name            String
  grade           String    // e.g. "Senior Dev", "Junior QA"
  effortFactor    Float     @default(1.0)
  attritionFactor Float     @default(1.0)
  standardRate    Float     // Hourly cost
  skills          String?   // JSON or CSV
  availability    Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("resources")
}

// ============================================================================
// OPPORTUNITIES & LIFECYCLE
// ============================================================================

model Opportunity {
  id                String   @id @default(cuid())
  title             String
  description       String?
  value             Decimal
  currency          String   @default("USD")
  probability       Int      @default(0)
  expectedCloseDate DateTime?
  actualCloseDate   DateTime?
  source            String?
  priority          String   @default("Medium")
  tags              String   
  metadata          Json?
  duplicateOf       String?
  isArchived        Boolean  @default(false)
  archivedAt        DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // -- New Lifecycle Fields --
  geolocation       String?
  salesRepName      String?
  
  // Pipeline, Presales, Sales
  currentStage      String   @default("Pipeline") 
  detailedStatus    String?  // e.g. "just received", "Estimation in progress"
  
  // Presales Data (JSON: { selectedResources: [], totalHours: 0, estimatedCost: 0, projectedQuote: 0, proposalUrl: "" })
  presalesData      Json?
  
  // Sales Data (JSON: { finalQuote: 0, category: "Assured" | "Probable" | "Unlikely", comparison: {} })
  salesData         Json?

  // Relations
  client            Client          @relation(fields: [clientId], references: [id])
  clientId          String
  owner             User            @relation("OpportunityOwner", fields: [ownerId], references: [id])
  ownerId           String
  team              Team?           @relation(fields: [teamId], references: [id])
  teamId            String?
  stage             Stage           @relation(fields: [stageId], references: [id])
  stageId           String
  type              OpportunityType @relation(fields: [typeId], references: [id])
  typeId            String

  // Child relations
  activities        Activity[]
  tasks             Task[]
  notes             Note[]
  attachments       Attachment[]
  stageHistory      StageHistory[]
  approvalRequests  ApprovalRequest[]
  aiInteractions    AIInteraction[]
  leadScore         LeadScore?
  vectorEmbedding   VectorEmbedding?

  @@index([clientId])
  @@index([ownerId])
  @@index([stageId])
  @@index([typeId])
  @@index([teamId])
  @@index([createdAt])
  @@index([expectedCloseDate])
  @@map("opportunities")
}

model Stage {
  id               String   @id @default(cuid())
  name             String   @unique
  order            Int
  probability      Int      @default(0)
  color            String   @default("#6B7280")
  isClosed         Boolean  @default(false)
  isWon            Boolean  @default(false)
  requiredFields   String   
  requiredDocs     String   
  allowedNextStages String  
  slaHours         Int?
  isSystem         Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  opportunities Opportunity[]
  stageHistory  StageHistory[]

  @@index([order])
  @@map("stages")
}

model OpportunityType {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  opportunities Opportunity[]

  @@map("opportunity_types")
}

model StageHistory {
  id            String   @id @default(cuid())
  enteredAt     DateTime @default(now())
  exitedAt      DateTime?
  durationHours Int?
  notes         String?

  opportunity   Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  opportunityId String
  stage         Stage       @relation(fields: [stageId], references: [id])
  stageId       String

  @@index([opportunityId])
  @@index([stageId])
  @@index([enteredAt])
  @@map("stage_history")
}

// ============================================================================
// ACTIVITIES & COLLABORATION
// ============================================================================

model Activity {
  id          String   @id @default(cuid())
  type        String
  subject     String?
  description String?
  duration    Int?
  scheduledAt DateTime?
  completedAt DateTime?
  outcome     String?
  isSystem    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  opportunity Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  opportunityId String
  user        User        @relation(fields: [userId], references: [id])
  userId      String
  contact     Contact?    @relation(fields: [contactId], references: [id])
  contactId   String?

  @@index([opportunityId])
  @@index([userId])
  @@index([type])
  @@index([scheduledAt])
  @@map("activities")
}

model Task {
  id          String    @id @default(cuid())
  title       String
  description String?
  dueDate     DateTime?
  completedAt DateTime?
  priority    String    @default("Medium")
  status      String    @default("Open")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  opportunity   Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  opportunityId String
  assignee      User        @relation("TaskAssignee", fields: [assigneeId], references: [id])
  assigneeId    String
  createdBy     User        @relation("TaskCreator", fields: [createdById], references: [id])
  createdById   String

  @@index([opportunityId])
  @@index([assigneeId])
  @@index([dueDate])
  @@index([status])
  @@map("tasks")
}

model Note {
  id          String   @id @default(cuid())
  content     String
  mentions    String   
  isPinned    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  opportunity   Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  opportunityId String
  author        User        @relation(fields: [authorId], references: [id])
  authorId      String

  @@index([opportunityId])
  @@index([authorId])
  @@map("notes")
}

model Attachment {
  id          String   @id @default(cuid())
  fileName    String
  fileType    String
  fileSize    Int
  filePath    String
  category    String?
  uploadedAt  DateTime @default(now())

  opportunity   Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  opportunityId String

  @@index([opportunityId])
  @@map("attachments")
}

// ============================================================================
// WORKFLOW & APPROVALS
// ============================================================================

model ApprovalRequest {
  id          String   @id @default(cuid())
  type        String
  reason      String?
  status      String   @default("Pending")
  comments    String?
  requestedAt DateTime @default(now())
  reviewedAt  DateTime?

  opportunity   Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  opportunityId String
  requester     User        @relation("ApprovalRequester", fields: [requesterId], references: [id])
  requesterId   String
  reviewer      User?       @relation("ApprovalReviewer", fields: [reviewerId], references: [id])
  reviewerId    String?

  @@index([opportunityId])
  @@index([status])
  @@map("approval_requests")
}

// ============================================================================
// NOTIFICATIONS
// ============================================================================

model Notification {
  id        String   @id @default(cuid())
  type      String
  title     String
  message   String
  link      String?
  isRead    Boolean  @default(false)
  readAt    DateTime?
  createdAt DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

model NotificationPreference {
  id      String  @id @default(cuid())
  channel String
  type    String
  enabled Boolean @default(true)

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  @@unique([userId, channel, type])
  @@map("notification_preferences")
}

// ============================================================================
// AI & AGENTIC FEATURES
// ============================================================================

model AIInteraction {
  id           String   @id @default(cuid())
  type         String
  prompt       String
  response     String
  status       String   @default("Pending")
  confidence   Float?
  toolsCalled  Json?
  cost         Decimal?
  latencyMs    Int?
  feedback     String?
  feedbackText String?
  createdAt    DateTime @default(now())
  reviewedAt   DateTime?

  user          User         @relation(fields: [userId], references: [id])
  userId        String
  opportunity   Opportunity? @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  opportunityId String?

  @@index([userId])
  @@index([opportunityId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@map("ai_interactions")
}

model LeadScore {
  id              String   @id @default(cuid())
  score           Int
  scoreVersion    String
  factors         Json
  confidence      Float
  recommendedAction String?
  calculatedAt    DateTime @default(now())
  
  opportunity   Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  opportunityId String      @unique

  @@index([score])
  @@map("lead_scores")
}

model VectorEmbedding {
  id        String   @id @default(cuid())
  embedding String   
  content   String
  metadata  Json?
  createdAt DateTime @default(now())

  opportunity   Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  opportunityId String      @unique

  @@map("vector_embeddings")
}

// ============================================================================
// SAVED VIEWS & PREFERENCES
// ============================================================================

model SavedView {
  id          String   @id @default(cuid())
  name        String
  filters     Json
  sortBy      Json?
  isDefault   Boolean  @default(false)
  isPublic    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  @@index([userId])
  @@map("saved_views")
}

// ============================================================================
// AUDIT & COMPLIANCE
// ============================================================================

model AuditLog {
  id          String   @id @default(cuid())
  entity      String
  entityId    String
  action      String
  changes     Json?
  ipAddress   String?
  userAgent   String?
  timestamp   DateTime @default(now())

  user   User?   @relation(fields: [userId], references: [id])
  userId String?

  @@index([entity, entityId])
  @@index([userId])
  @@index([timestamp])
  @@map("audit_logs")
}

model SystemConfig {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  category  String
  description String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@map("system_config")
}
